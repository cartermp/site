<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Note: this post does not apply to Jetbrains Rider. Rider uses its own engine for representing F# syntax expressions and has its own strongly-typed API for traversing and manipulating F# expressions.
F# tooling in Visual Studio and Visual Studio Code supports a variety quick fixes for fixing an error in your code. Here&rsquo;s an example of one:
 Wrap Expression in Parentheses Quick Fix   Pretty neat, right? This post will walk through the essentials of implementing a quick fix like this in either Visual Studio or VSCode."><meta name=author content="Phillip Carter"><title>How to make an F# code fixer | Phillip Carter's blog</title><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><meta property="og:title" content="How to make an F# code fixer"><meta property="og:description" content="Note: this post does not apply to Jetbrains Rider. Rider uses its own engine for representing F# syntax expressions and has its own strongly-typed API for traversing and manipulating F# expressions.
F# tooling in Visual Studio and Visual Studio Code supports a variety quick fixes for fixing an error in your code. Here&rsquo;s an example of one:
 Wrap Expression in Parentheses Quick Fix   Pretty neat, right? This post will walk through the essentials of implementing a quick fix like this in either Visual Studio or VSCode."><meta property="og:type" content="article"><meta property="og:url" content="https://phillipcarter.dev/posts/how-to-make-an-fsharp-code-fixer/"><meta property="og:image" content="https://phillipcarter.dev/favicon/android-chrome-512x512.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-12-04T00:00:00+00:00"><meta property="article:modified_time" content="2021-02-28T16:22:54-08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://phillipcarter.dev/favicon/android-chrome-512x512.png"><meta name=twitter:title content="How to make an F# code fixer"><meta name=twitter:description content="Note: this post does not apply to Jetbrains Rider. Rider uses its own engine for representing F# syntax expressions and has its own strongly-typed API for traversing and manipulating F# expressions.
F# tooling in Visual Studio and Visual Studio Code supports a variety quick fixes for fixing an error in your code. Here&rsquo;s an example of one:
 Wrap Expression in Parentheses Quick Fix   Pretty neat, right? This post will walk through the essentials of implementing a quick fix like this in either Visual Studio or VSCode."><link rel=preload as=font href=/fonts/Metropolis.woff2 type=font/woff2 crossorigin=anonymous><link rel=preload as=font href=/fonts/LiberationSans.woff2 type=font/woff2 crossorigin=anonymous><link rel=preload as=font href=/fonts/LiberationSans-Bold.woff2 type=font/woff2 crossorigin=anonymous><link rel=preload as=font href=/fonts/LiberationSans-BoldItalic.woff2 type=font/woff2 crossorigin=anonymous><link rel=preload as=font href=/fonts/LiberationSans-Italic.woff2 type=font/woff2 crossorigin=anonymous><link rel=preload as=font href=/fonts/LiberationMono.woff2 type=font/woff2 crossorigin=anonymous><link rel=preload as=font href=/fonts/DroidSans.woff2 type=font/woff2 crossorigin=anonymous><link rel=preload as=font href=/fonts/GeekblogIcons.woff2 type=font/woff2 crossorigin=anonymous><link rel=preload href=/main-342b625c73.min.css as=style><link rel=stylesheet href=/main-342b625c73.min.css media=all><link rel=preload href=/mobile-14fbbb71d2.min.css as=style><link rel=stylesheet href=/mobile-14fbbb71d2.min.css media="screen and (max-width: 45rem)"><link rel=preload href=/print-86167e859a.min.css as=style><link rel=stylesheet href=/print-86167e859a.min.css media=print><link rel=preload href=/custom.css as=style><link rel=stylesheet href=/custom.css media=all><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"posts","name":"How to make an F# code fixer","headline":"How to make an F# code fixer","alternativeHeadline":"","description":"Note: this post does not apply to Jetbrains Rider. Rider uses its own engine for representing F# syntax expressions and has its own strongly-typed API for traversing and manipulating F# expressions.\nF# tooling in Visual Studio and Visual Studio Code supports a variety quick fixes for fixing an error in your code. Here\u0026rsquo;s an example of one:\n Wrap Expression in Parentheses Quick Fix   Pretty neat, right? This post will walk through the essentials of implementing a quick fix like this in either Visual Studio or VSCode.","inLanguage":"en","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/phillipcarter.dev\/posts\/how-to-make-an-fsharp-code-fixer\/"},"author":[{"@type":"Person","name":"Phillip Carter"}],"copyrightHolder":"Phillip Carter\u0027s blog","copyrightYear":"2020","dateCreated":"2020-12-04T00:00:00.00Z","datePublished":"2020-12-04T00:00:00.00Z","dateModified":"2021-02-28T16:22:54.00Z","publisher":{"@type":"Organization","name":"Phillip Carter's blog","url":"https://phillipcarter.dev","logo":{"@type":"ImageObject","url":"https:\/\/phillipcarter.dev\/brand.svg","width":"32","height":"32"}},"image":["https:\/\/phillipcarter.dev\/posts\/how-to-make-an-fsharp-code-fixer\/images\/wrap-expression-in-parentheses.png"],"url":"https:\/\/phillipcarter.dev\/posts\/how-to-make-an-fsharp-code-fixer\/","wordCount":"3640","genre":["fsharp","Visual Studio"]}</script></head><body><svg style="position:absolute;width:0;height:0;overflow:hidden" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><symbol viewBox="-7.27 -7.27 46.55 46.55" id="arrow_back" xmlns="http://www.w3.org/2000/svg"><path d="M31.999 14.035v3.93H7.673l11.134 11.228L16 32 .001 16.001 16 .002l2.807 2.807L7.673 14.037h24.326z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="arrow_left" xmlns="http://www.w3.org/2000/svg"><path d="M7.954 17.965v5.988L.001 16l7.953-7.953v5.988H32v3.93H7.954z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="arrow_right" xmlns="http://www.w3.org/2000/svg"><path d="M24.046 14.035V8.047L31.999 16l-7.953 7.953v-5.988H0v-3.93h24.046z"/></symbol><symbol viewBox="-7.27 -7.27 42.55 42.55" id="bitbucket" xmlns="http://www.w3.org/2000/svg"><path d="M15.905 13.355c.189 1.444-1.564 2.578-2.784 1.839-1.375-.602-1.375-2.784-.034-3.403 1.151-.705 2.818.223 2.818 1.564zm1.907-.361c-.309-2.44-3.076-4.056-5.328-3.042-1.426.636-2.389 2.148-2.32 3.747.086 2.097 2.08 3.815 4.176 3.626s3.729-2.234 3.472-4.331zm4.108-9.315c-.756-.997-2.045-1.169-3.179-1.358-3.214-.516-6.513-.533-9.727.034-1.066.172-2.269.361-2.939 1.323 1.1 1.031 2.664 1.186 4.073 1.358 2.544.327 5.156.344 7.699.017 1.426-.172 3.008-.309 4.073-1.375zm.979 17.788c-.481 1.684-.206 3.953-1.994 4.932-3.076 1.701-6.806 1.89-10.191 1.289-1.787-.327-3.884-.894-4.864-2.578-.43-1.65-.705-3.334-.98-5.018l.103-.275.309-.155c5.121 3.386 12.288 3.386 17.427.0.808.241.206 1.22.189 1.805zM26.01 4.951c-.584 3.764-1.255 7.51-1.908 11.257-.189 1.1-1.255 1.719-2.148 2.183-3.214 1.615-6.96 1.89-10.483 1.512-2.389-.258-4.829-.894-6.771-2.389-.911-.705-.911-1.908-1.083-2.922-.602-3.523-1.289-7.046-1.719-10.604.206-1.547 1.942-2.217 3.231-2.698C6.848.654 8.686.362 10.508.19c3.884-.378 7.854-.241 11.618.859 1.341.395 2.784.945 3.695 2.097.412.533.275 1.203.189 1.805z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="bookmarks" xmlns="http://www.w3.org/2000/svg"><path d="M20.357 5.856q1.157.0 2.043.851t.885 2.008v23.284l-10.212-4.357-10.144 4.357V8.715q0-1.157.885-2.008t2.042-.851h14.502zm5.787 18.859V5.856q0-1.157-.851-2.042t-2.008-.885H8.715q0-1.157.885-2.042t2.043-.885h14.502q1.157.0 2.043.885t.885 2.042v23.216z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="clear" xmlns="http://www.w3.org/2000/svg"><path d="M32 3.222 19.222 16 32 28.778l-3.221 3.221-12.778-12.778L3.223 31.999.002 28.778 12.78 16 .002 3.222 3.223.001l12.778 12.778L28.779.001z"/></symbol><symbol viewBox="-7.27 -7.27 42.55 42.55" id="code" xmlns="http://www.w3.org/2000/svg"><path d="M9.917 24.5a1.75 1.75.0 10-3.501.001 1.75 1.75.0 003.501-.001zm0-21a1.75 1.75.0 10-3.501.001A1.75 1.75.0 009.917 3.5zm11.666 2.333a1.75 1.75.0 10-3.501.001 1.75 1.75.0 003.501-.001zm1.75.0a3.502 3.502.0 01-1.75 3.026c-.055 6.581-4.721 8.039-7.82 9.023-2.898.911-3.846 1.349-3.846 3.117v.474a3.502 3.502.0 011.75 3.026c0 1.932-1.568 3.5-3.5 3.5s-3.5-1.568-3.5-3.5c0-1.294.711-2.424 1.75-3.026V6.526A3.502 3.502.0 014.667 3.5c0-1.932 1.568-3.5 3.5-3.5s3.5 1.568 3.5 3.5a3.502 3.502.0 01-1.75 3.026v9.06c.93-.456 1.914-.766 2.807-1.039 3.391-1.075 5.323-1.878 5.359-5.687a3.502 3.502.0 01-1.75-3.026c0-1.932 1.568-3.5 3.5-3.5s3.5 1.568 3.5 3.5z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="contacts" xmlns="http://www.w3.org/2000/svg"><path d="M22.688 22.688v-2q0-1.5-2.281-2.438t-4.406-.938-4.406.938-2.281 2.438v2h13.375zM16 9q-1.25.0-2.125.875T13 12t.875 2.125T16 15t2.125-.875T19 12t-.875-2.125T16 9zm10.688-3.687q1.063.0 1.844.813t.781 1.875v16q0 1.063-.781 1.875t-1.844.813H5.313q-1.063.0-1.844-.813t-.781-1.875v-16q0-1.063.781-1.875t1.844-.813h21.375zM5.313 32v-2.688h21.375V32H5.313zM26.688.0v2.688H5.313V0h21.375z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="create" xmlns="http://www.w3.org/2000/svg"><path d="M31.499 7.167l-3.25 3.25-6.666-6.666 3.25-3.25q.5-.5 1.25-.5t1.25.5l4.166 4.166q.5.5.5 1.25t-.5 1.25zM.001 25.333 19.667 5.667l6.666 6.666L6.667 31.999H.001v-6.666z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="date" xmlns="http://www.w3.org/2000/svg"><path d="M27.192 28.844V11.192H4.808v17.652h22.384zm0-25.689q1.277.0 2.253.976t.976 2.253v22.459q0 1.277-.976 2.216t-2.253.939H4.808q-1.352.0-2.291-.901t-.939-2.253V6.385q0-1.277.939-2.253t2.291-.976h1.577V.001h3.23v3.155h12.769V.001h3.23v3.155h1.577zm-3.155 11.267v3.155h-3.23v-3.155h3.23zm-6.46.0v3.155h-3.155v-3.155h3.155zm-6.384.0v3.155h-3.23v-3.155h3.23z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="download" xmlns="http://www.w3.org/2000/svg"><path d="M2.866 28.209h26.269v3.79H2.866v-3.79zm26.268-16.925L16 24.418 2.866 11.284h7.493V.001h11.283v11.283h7.493z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="email" xmlns="http://www.w3.org/2000/svg"><path d="M28.845 9.615v-3.23L16 14.422 3.155 6.385v3.23L16 17.577zm0-6.46q1.277.0 2.216.977T32 6.385v19.23q0 1.277-.939 2.253t-2.216.977H3.155q-1.277.0-2.216-.977T0 25.615V6.385q0-1.277.939-2.253t2.216-.977h25.69z"/></symbol><symbol viewBox="-7.27 -7.27 42.55 42.55" id="git" xmlns="http://www.w3.org/2000/svg"><path d="M27.472 12.753 15.247.529a1.803 1.803.0 00-2.55.0l-2.84 2.84 2.137 2.137a2.625 2.625.0 013.501 3.501l3.499 3.499a2.625 2.625.0 11-1.237 1.237l-3.499-3.499c-.083.04-.169.075-.257.106v7.3a2.626 2.626.0 11-1.75.0v-7.3a2.626 2.626.0 01-1.494-3.607L8.62 4.606l-8.09 8.09a1.805 1.805.0 000 2.551l12.225 12.224a1.803 1.803.0 002.55.0l12.168-12.168a1.805 1.805.0 000-2.551z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="github" xmlns="http://www.w3.org/2000/svg"><path d="M16 .394c8.833.0 15.999 7.166 15.999 15.999.0 7.062-4.583 13.062-10.937 15.187-.813.146-1.104-.354-1.104-.771.0-.521.021-2.25.021-4.396.0-1.5-.5-2.458-1.083-2.958 3.562-.396 7.312-1.75 7.312-7.896.0-1.75-.625-3.167-1.646-4.291.167-.417.708-2.042-.167-4.25-1.333-.417-4.396 1.646-4.396 1.646a15.032 15.032.0 00-8 0S8.937 6.602 7.603 7.018c-.875 2.208-.333 3.833-.167 4.25-1.021 1.125-1.646 2.542-1.646 4.291.0 6.125 3.729 7.5 7.291 7.896-.458.417-.875 1.125-1.021 2.146-.917.417-3.25 1.125-4.646-1.333-.875-1.521-2.458-1.646-2.458-1.646-1.562-.021-.104.979-.104.979 1.042.479 1.771 2.333 1.771 2.333.938 2.854 5.396 1.896 5.396 1.896.0 1.333.021 2.583.021 2.979.0.417-.292.917-1.104.771C4.582 29.455-.001 23.455-.001 16.393-.001 7.56 7.165.394 15.998.394zM6.063 23.372c.042-.083-.021-.187-.146-.25-.125-.042-.229-.021-.271.042-.042.083.021.187.146.25.104.062.229.042.271-.042zm.646.709c.083-.062.062-.208-.042-.333-.104-.104-.25-.146-.333-.062-.083.062-.062.208.042.333.104.104.25.146.333.062zm.625.937c.104-.083.104-.25.0-.396-.083-.146-.25-.208-.354-.125-.104.062-.104.229.0.375s.271.208.354.146zm.875.875c.083-.083.042-.271-.083-.396-.146-.146-.333-.167-.417-.062-.104.083-.062.271.083.396.146.146.333.167.417.062zm1.187.521c.042-.125-.083-.271-.271-.333-.167-.042-.354.021-.396.146s.083.271.271.312c.167.062.354.0.396-.125zm1.313.104c0-.146-.167-.25-.354-.229-.187.0-.333.104-.333.229.0.146.146.25.354.229.187.0.333-.104.333-.229zm1.208-.208c-.021-.125-.187-.208-.375-.187-.187.042-.312.167-.292.312.021.125.187.208.375.167s.312-.167.292-.292z"/></symbol><symbol viewBox="-7.27 -7.27 42.55 42.55" id="gitlab" xmlns="http://www.w3.org/2000/svg"><path d="M1.629 11.034 14 26.888.442 17.048a1.09 1.09.0 01-.39-1.203l1.578-4.811zm7.217.0h10.309l-5.154 15.854zM5.753 1.475l3.093 9.559H1.63l3.093-9.559a.548.548.0 011.031.0zm20.618 9.559 1.578 4.811c.141.437-.016.922-.39 1.203l-13.558 9.84 12.371-15.854zm0 0h-7.216l3.093-9.559a.548.548.0 011.031.0z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="heart" xmlns="http://www.w3.org/2000/svg"><path d="M16 29.714a1.11 1.11.0 01-.786-.321L4.072 18.643c-.143-.125-4.071-3.714-4.071-8 0-5.232 3.196-8.357 8.535-8.357 3.125.0 6.053 2.464 7.464 3.857 1.411-1.393 4.339-3.857 7.464-3.857 5.339.0 8.535 3.125 8.535 8.357.0 4.286-3.928 7.875-4.089 8.035L16.785 29.392c-.214.214-.5.321-.786.321z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="keyborad_arrow_left" xmlns="http://www.w3.org/2000/svg"><path d="M25.875 28.25 22.125 32 6.126 16.001 22.125.002l3.75 3.75-12.25 12.25z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="keyborad_arrow_right" xmlns="http://www.w3.org/2000/svg"><path d="M6.125 28.25 18.375 16 6.125 3.75 9.875.0l15.999 15.999L9.875 31.998z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="link" xmlns="http://www.w3.org/2000/svg"><path d="M24.037 7.963q3.305.0 5.634 2.366T32 16t-2.329 5.671-5.634 2.366h-6.46v-3.08h6.46q2.028.0 3.493-1.465t1.465-3.493-1.465-3.493-3.493-1.465h-6.46v-3.08h6.46zM9.615 17.578v-3.155h12.77v3.155H9.615zM3.005 16q0 2.028 1.465 3.493t3.493 1.465h6.46v3.08h-6.46q-3.305.0-5.634-2.366T0 16.001t2.329-5.671 5.634-2.366h6.46v3.08h-6.46q-2.028.0-3.493 1.465t-1.465 3.493z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="menu" xmlns="http://www.w3.org/2000/svg"><path d="M.001 5.334h31.998v3.583H.001V5.334zm0 12.416v-3.5h31.998v3.5H.001zm0 8.916v-3.583h31.998v3.583H.001z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="notifications" xmlns="http://www.w3.org/2000/svg"><path d="M25.846 22.154l3.308 3.308v1.615H2.847v-1.615l3.308-3.308V14q0-3.846 1.961-6.692t5.423-3.692V2.462q0-1 .692-1.731T16 0t1.769.731.692 1.731v1.154q3.461.846 5.423 3.692T25.846 14v8.154zM16 32q-1.385.0-2.346-.923t-.962-2.308h6.615q0 1.308-1 2.269T15.999 32z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="person" xmlns="http://www.w3.org/2000/svg"><path d="M16 20.023q5.052.0 10.526 2.199t5.473 5.754v4.023H0v-4.023q0-3.555 5.473-5.754t10.526-2.199zM16 16q-3.275.0-5.614-2.339T8.047 8.047t2.339-5.661T16 0t5.614 2.386 2.339 5.661-2.339 5.614T16 16z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="pin" xmlns="http://www.w3.org/2000/svg"><path d="M17.6 19.2h9.6v-1.6L22.4 16V3.2l4.8-1.6V0H4.8v1.6l4.8 1.6V16l-4.8 1.6v1.6h9.6v11.2L16 32l1.6-1.6V19.2z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="rss_feed" xmlns="http://www.w3.org/2000/svg"><path d="M-.481 12.048q8.482.0 14.457 5.976t5.976 14.457h-5.879q0-5.976-4.289-10.264T-.48 17.928v-5.879zm0-11.565q13.204.0 22.601 9.397t9.397 22.601h-5.783q0-10.891-7.662-18.553T-.481 6.266V.483zm0 27.468q0-1.831 1.301-3.132t3.229-1.301 3.181 1.253 1.253 3.181-1.301 3.229-3.132 1.301q-1.928.0-3.229-1.301T-.48 27.952z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="search" xmlns="http://www.w3.org/2000/svg"><path d="M11.925 20.161q3.432.0 5.834-2.402t2.402-5.834-2.402-5.834-5.834-2.402-5.834 2.402-2.402 5.834 2.402 5.834 5.834 2.402zm10.981.0L32 29.255 29.255 32l-9.094-9.094v-1.458l-.515-.515q-3.26 2.831-7.721 2.831-4.976.0-8.45-3.432T.001 11.925t3.474-8.45 8.45-3.474 8.407 3.474 3.432 8.45q0 1.802-.858 4.075t-1.973 3.646l.515.515h1.458z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="security" xmlns="http://www.w3.org/2000/svg"><path d="M16 0l13.072 5.855v8.715q0 6.059-3.745 11.063T16 31.999q-5.583-1.362-9.327-6.366T2.928 14.57V5.855zm0 16v13.004q4.017-1.294 6.808-4.868T26.144 16H16zm0 0V3.2L5.856 7.693v8.306H16z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="telescope" xmlns="http://www.w3.org/2000/svg"><path d="M25.026 3.335a.466.466.0 00-.646-.238L13.362 8.91a.463.463.0 00-.216.575l.227.593-6.36 3.488a.462.462.0 00-.205.583l.211.508-6.755 3.228a.463.463.0 00-.228.595l1.386 3.341a.463.463.0 00.583.259l7.056-2.5.211.508a.462.462.0 00.557.267l6.733-1.941.202.527a.46.46.0 00.566.277l12.03-3.702a.46.46.0 00.293-.613L25.026 3.335zM2.109 21.061l-1.049-2.53 6.314-3.018 1.332 3.211-6.596 2.337zm7.857-1.708-.22-.531-1.706-4.113-.22-.53 5.863-3.216 2.197 5.676.347.908-6.261 1.806zm7.505-1.146-.188-.491c-.003-.01-.001-.022-.006-.032l-.572-1.478-2.549-6.668 10.201-5.381 4.249 10.624-11.136 3.428zm8.943-16.723a.463.463.0 00-.86.344l5.552 13.881a.464.464.0 00.602.258.464.464.0 00.258-.602L26.413 1.484zM16.268 20.627h-2.776c-1.055.0-1.851.796-1.851 1.851v1.217l-5.44 6.347a.462.462.0 10.702.602l5.415-6.316h2.101v6.015a.463.463.0 00.926.0v-6.015h2.101l5.414 6.316a.462.462.0 10.703-.602l-5.44-6.347v-1.148c0-1.076-.813-1.92-1.851-1.92zm.925 2.777h-4.627v-.925c0-.545.38-.925.925-.925h2.776c.527.0.925.428.925.995v.856z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="timer" xmlns="http://www.w3.org/2000/svg"><path d="M16 29q4.428.0 7.536-3.143t3.107-7.571-3.107-7.536T16 7.643 8.464 10.75t-3.107 7.536 3.107 7.571T16 29zM26.714 9.786q1.214 1.571 2.107 4.036t.893 4.464q0 5.643-4 9.678T16 32t-9.714-4.036-4-9.678 4-9.678T16 4.572q1.929.0 4.464.929t4.107 2.143l2.143-2.214q1.143.929 2.143 2.143zM14.5 19.857v-9.143h3v9.143h-3zM20.571.001v3.071h-9.143V.001h9.143z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="tree" xmlns="http://www.w3.org/2000/svg"><path d="M32 14.423H20.808V9.616h-3.23v12.77h3.23v-4.807H32v12.845H20.808v-4.807h-6.385v-16h-3.23v4.807H.001V1.579h11.192v4.807h9.615V1.579H32v12.845z"/></symbol></svg><div class=wrapper><header class=gblog-header><div class="container flex align-center justify-center"><a class=gblog-header__link rel=me href=https://phillipcarter.dev><span class="gblog-brand flex align-center justify-center">Phillip Carter's blog</span>
<span class="gblog-brand__subtitle flex align-center justify-center">Usually writing about F#</span></a></div></header><nav class=gblog-nav><input type=checkbox id=menu-control class=hidden><div class=gblog-nav__control><label for=menu-control class="flex align-center justify-center"><svg class="icon menu"><use xlink:href="#menu"/></svg><svg class="icon clear"><use xlink:href="#clear"/></svg><span>Nav</span></label></div><ul class="gblog-nav__list container flex flex-wrap justify-center menu-content"><li><a class=gblog-nav__entry href=/tags/fsharp/>fsharp</a></li><li><a class=gblog-nav__entry href=/tags/microsoft/>Microsoft</a></li><li><a class=gblog-nav__entry href=/tags/open-source/>open source</a></li><li><a class=gblog-nav__entry href=/tags/visual-studio/>Visual Studio</a></li></ul></nav><main class="gblog-page container"><article class=gblog-post><header class=gblog-post__header><h1>How to make an F# code fixer</h1><div class=gblog-post__meta><span class=no-wrap><svg class="icon date"><use xlink:href="#date"/></svg><span class=gblog-post__tag><time datetime=2021-02-28T16:22:54-08:00>Updated on
Feb 28, 2021</time></span></span>
<span class=no-wrap><svg class="icon timer"><use xlink:href="#timer"/></svg><span class=gblog-post__tag>18 min read</span></span></div></header><section class=gblog-markdown><p>Note: this post does not apply to Jetbrains Rider. Rider uses its own engine for representing F# syntax expressions and has its own strongly-typed API for traversing and manipulating F# expressions.</p><p>F# tooling in Visual Studio and Visual Studio Code supports a variety quick fixes for fixing an error in your code. Here&rsquo;s an example of one:</p><div class="flex justify-center"><figure class=gblog-post__figure><a class=gblog-post__link--raw href=/posts/how-to-make-an-fsharp-code-fixer/images/wrap-expression-in-parentheses.png><img loading=lazy src=/posts/how-to-make-an-fsharp-code-fixer/images/wrap-expression-in-parentheses_hu8e09b360e18351fba4f756a57821447e_57981_600x0_resize_box_2.png alt="Wrap Expression in Parentheses Quick Fix"></a><figcaption>Wrap Expression in Parentheses Quick Fix</figcaption></figure></div><p>Pretty neat, right? This post will walk through the essentials of implementing a quick fix like this in either Visual Studio or VSCode.</p><div class=gblog-post__anchorwrap><h2 id=the-essential-pieces-of-an-editor-quick-fixer>The essential pieces of an editor Quick Fixer
<a data-clipboard-text=https://phillipcarter.dev/posts/how-to-make-an-fsharp-code-fixer/#the-essential-pieces-of-an-editor-quick-fixer class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor The essential pieces of an editor Quick Fixer" href=#the-essential-pieces-of-an-editor-quick-fixer><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>Quick Fixes are pretty straightforward. They are comprised of 3 things:</p><ol><li>An editing environment that can &ldquo;listen&rdquo; for specific diagnostics (tracked by ID) and allow you to plug into that engine</li><li>A &ldquo;context&rdquo; for a Quick Fix that crucially contains the span/range of text in a document corresponding to an error or warning</li><li>Some code that registers itself as a plugin for that diagnostic ID and/or message contents, and/or some other condition (more on that later)</li><li>Some code that performs logic that rewrites a small section of the user&rsquo;s code to fix an issue
And that&rsquo;s it! The lifecycle is pretty simple, too:</li></ol><p>Periodically, an editing environment calls into the F# language service to process syntax and typecheck. This happens most often when you&rsquo;re typing (after a very short delay to account for the typing). When it&rsquo;s finished and there are syntax or typechecking errors, it raises appropriate diagnostics for the editing environment to report.</p><p>When this happens, any quick fix that is registered to &ldquo;listen&rdquo; to a particular diagnostic is made available to be triggered if and only if that diagnostic was raised. When the user does something like click a lightbulb in an editor or hit the right key command, all Quick Fixes that are available at that position are executed asynchronously, and the syntax transformation that they offer is also made available.</p><div class=gblog-post__anchorwrap><h2 id=each-editor-has-their-own-apis>Each editor has their own APIs
<a data-clipboard-text=https://phillipcarter.dev/posts/how-to-make-an-fsharp-code-fixer/#each-editor-has-their-own-apis class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Each editor has their own APIs" href=#each-editor-has-their-own-apis><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>First things first: you can&rsquo;t just copy/paste a quick fix from Visual Studio into VSCode or vice/versa. Although a quick fix can share the same logic across editors, it must ultimately bind to the particular editor API that hosts it.</p><p>In the case of Visual Studio tooling for F#, the skeleton that wraps any custom logic generally looks like this:</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>namespace</span> <span class=nn>Microsoft</span><span class=p>.</span><span class=nn>VisualStudio</span><span class=p>.</span><span class=nn>FSharp</span><span class=p>.</span><span class=n>Editor</span>

<span class=k>open</span> <span class=nn>System.Composition</span>
<span class=k>open</span> <span class=nn>System.Threading</span>
<span class=k>open</span> <span class=nn>System.Threading.Tasks</span>

<span class=k>open</span> <span class=nn>Microsoft.CodeAnalysis.Text</span>
<span class=k>open</span> <span class=nn>Microsoft.CodeAnalysis.CodeFixes</span>
<span class=k>open</span> <span class=nn>Microsoft.CodeAnalysis.CodeActions</span>

<span class=o>[&lt;</span><span class=n>ExportCodeFixProvider</span><span class=o>(</span><span class=nn>FSharpConstants</span><span class=p>.</span><span class=n>FSharpLanguageName</span><span class=o>,</span> <span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;NAME HERE&#34;</span><span class=o>);</span> <span class=n>Shared</span><span class=o>&gt;]</span>
<span class=k>type</span> <span class=nc>internal</span> <span class=n>FSharpYourQuickFixNameHereFixProvider</span><span class=bp>()</span> <span class=o>=</span>
    <span class=k>inherit</span> <span class=n>CodeFixProvider</span><span class=bp>()</span>

    <span class=c1>// Any applicable diagnostic IDs go here
</span><span class=c1></span>    <span class=k>let</span> <span class=nv>fixableDiagnosticIds</span> <span class=o>=</span> <span class=n>set</span> <span class=o>[</span><span class=s>&#34;FSXYZ&#34;</span><span class=o>]</span>

    <span class=k>override</span> <span class=n>_</span><span class=p>.</span><span class=nf>FixableDiagnosticIds</span> <span class=o>=</span> <span class=nn>Seq</span><span class=p>.</span><span class=n>toImmutableArray</span> <span class=n>fixableDiagnosticIds</span>

    <span class=k>override</span> <span class=n>this</span><span class=p>.</span><span class=nf>RegisterCodeFixesAsync</span> <span class=n>context</span> <span class=o>:</span> <span class=n>Task</span> <span class=o>=</span>
        <span class=n>async</span> <span class=o>{</span>
            <span class=c1>// Title comes from a resource file
</span><span class=c1></span>            <span class=k>let</span> <span class=nv>title</span> <span class=o>=</span> <span class=nn>SR</span><span class=p>.</span><span class=n>WrapExpressionInParentheses</span><span class=bp>()</span>

            <span class=c1>// Custom logic can be written or called here
</span><span class=c1></span>
            <span class=k>let</span> <span class=nv>applicableIDs</span> <span class=o>=</span>
                <span class=n>context</span><span class=o>.</span><span class=n>Diagnostics</span>
                <span class=o>|&gt;</span> <span class=nn>Seq</span><span class=p>.</span><span class=n>filter</span> <span class=o>(</span><span class=k>fun</span> <span class=n>x</span> <span class=o>-&gt;</span> <span class=n>this</span><span class=o>.</span><span class=n>FixableDiagnosticIds</span><span class=o>.</span><span class=n>Contains</span> <span class=n>x</span><span class=o>.</span><span class=n>Id</span><span class=o>)</span>
                <span class=o>|&gt;</span> <span class=nn>Seq</span><span class=p>.</span><span class=n>toImmutableArray</span>

            <span class=n>context</span><span class=o>.</span><span class=n>RegisterCodeFix</span><span class=o>(</span>
                <span class=nn>CodeAction</span><span class=p>.</span><span class=n>Create</span><span class=o>(</span>
                    <span class=n>title</span><span class=o>,</span>
                    <span class=o>(</span><span class=k>fun</span> <span class=o>(</span><span class=n>cancellationToken</span><span class=o>:</span> <span class=n>CancellationToken</span><span class=o>)</span> <span class=o>-&gt;</span>
                        <span class=n>async</span> <span class=o>{</span>
                            <span class=k>let!</span> <span class=nv>sourceText</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>Document</span><span class=o>.</span><span class=n>GetTextAsync</span><span class=o>(</span><span class=n>cancellationToken</span><span class=o>)</span> <span class=o>|&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>AwaitTask</span>
                            <span class=k>return</span> <span class=n>context</span><span class=o>.</span><span class=n>Document</span><span class=o>.</span><span class=n>WithText</span><span class=o>(</span><span class=c>(* TODO - code that changes text *)</span><span class=o>)</span>
                        <span class=o>}</span> <span class=o>|&gt;</span> <span class=nn>RoslynHelpers</span><span class=p>.</span><span class=n>StartAsyncAsTask</span><span class=o>(</span><span class=n>cancellationToken</span><span class=o>)),</span>
                    <span class=n>title</span><span class=o>),</span>
                    <span class=n>applicableIDs</span><span class=o>)</span>
        <span class=o>}</span> <span class=o>|&gt;</span> <span class=nn>RoslynHelpers</span><span class=p>.</span><span class=n>StartAsyncUnitAsTask</span><span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=n>CancellationToken</span><span class=o>)</span>
</code></pre></div><p>It may seem like there&rsquo;s a lot going on here, but most of it is just glue code to ensure that everything is asynchronous and cancellable and runs in the Roslyn workspace host inside of Visual Studio. They key pieces are there:</p><p>Configuring a set of applicable diagnostics for the code fix
Code that registers a quick fix for the applicable diagnostics (asynchronous and cancellable)
Spots in the code to enter in custom logic and logic for manipulating user code
In VSCode (technically FsAutocomplete), a quick fix skeleton might look similar to this:</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>let</span> <span class=nv>yourCustomeCodeFix</span> <span class=o>(</span><span class=n>getFileLines</span><span class=o>:</span> <span class=kt>string</span> <span class=o>-&gt;</span> <span class=n>Result</span><span class=o>&lt;</span><span class=kt>string</span> <span class=bp>[]</span><span class=o>,</span> <span class=o>_&gt;):</span> <span class=n>CodeFix</span> <span class=o>=</span>
    <span class=n>ifDiagnosticByCode</span>
        <span class=o>(</span><span class=k>fun</span> <span class=n>diagnostic</span> <span class=n>codeActionParams</span> <span class=o>-&gt;</span>
            <span class=k>match</span> <span class=n>getFileLines</span> <span class=o>(</span><span class=n>codeActionParams</span><span class=o>.</span><span class=n>TextDocument</span><span class=o>.</span><span class=n>GetFilePath</span><span class=bp>()</span><span class=o>)</span> <span class=k>with</span>
            <span class=o>|</span> <span class=n>Ok</span> <span class=n>lines</span> <span class=o>-&gt;</span>
                <span class=k>let</span> <span class=nv>erroringExpression</span> <span class=o>=</span> <span class=n>getText</span> <span class=n>lines</span> <span class=n>diagnostic</span><span class=o>.</span><span class=n>Range</span>
                <span class=n>async</span><span class=o>.</span><span class=n>Return</span> <span class=o>[</span> <span class=o>{</span> <span class=n>Title</span> <span class=o>=</span> <span class=s>&#34;your title here&#34;</span>
                                 <span class=n>File</span> <span class=o>=</span> <span class=n>codeActionParams</span><span class=o>.</span><span class=n>TextDocument</span>
                                 <span class=n>SourceDiagnostic</span> <span class=o>=</span> <span class=n>Some</span> <span class=n>diagnostic</span>
                                 <span class=n>Edits</span> <span class=o>=</span>
                                    <span class=o>[|</span> <span class=o>{</span> <span class=n>Range</span> <span class=o>=</span> <span class=n>diagnostic</span><span class=o>.</span><span class=n>Range</span>
                                         <span class=n>NewText</span> <span class=o>=</span> <span class=s>&#34;&#34;</span> <span class=c>(* TODO - define new text *)</span> <span class=o>}</span> <span class=o>|]</span>
                                 <span class=n>Kind</span> <span class=o>=</span> <span class=n>Fix</span> <span class=o>}</span> <span class=o>]</span>
            <span class=o>|</span> <span class=n>Error</span> <span class=o>_</span> <span class=o>-&gt;</span> <span class=n>async</span><span class=o>.</span><span class=n>Return</span> <span class=bp>[]</span><span class=o>)</span>
        <span class=o>(</span><span class=nn>Set</span><span class=p>.</span><span class=n>ofList</span> <span class=o>[</span> <span class=s>&#34;DIAGNOSTIC-IDS-HERE&#34;</span> <span class=o>])</span>
</code></pre></div><p>Due to some nice helper functionality it&rsquo;s less code, but the basic pieces are all the same.</p><div class=gblog-post__anchorwrap><h2 id=easy-quick-fixer-example-just-manipulating-text>Easy quick fixer example: just manipulating text
<a data-clipboard-text=https://phillipcarter.dev/posts/how-to-make-an-fsharp-code-fixer/#easy-quick-fixer-example-just-manipulating-text class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Easy quick fixer example: just manipulating text" href=#easy-quick-fixer-example-just-manipulating-text><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>Sometimes, a quick fix can be trivial to implement because all you need to do is change an obviously incorrect span of text in a user&rsquo;s source code. The following example comes from a very common error:</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>let</span> <span class=nv>rng</span> <span class=o>=</span> <span class=nn>System</span><span class=p>.</span><span class=n>Random</span><span class=bp>()</span>
<span class=k>let</span> <span class=nv>makeBigger</span> <span class=n>x</span> <span class=o>=</span> <span class=n>x</span> <span class=o>*</span> <span class=n>2</span>
<span class=n>makeBigger</span> <span class=n>rng</span><span class=o>.</span><span class=n>Next</span><span class=o>(</span><span class=n>5</span><span class=o>)</span>
</code></pre></div><p>This code seems like it might be right, but the compiler complains because it thinks that the <code>(5)</code> is another argument being passed to <code>makeBigger</code>. It&rsquo;s a &ldquo;classic&rdquo; F# compiler error that is usually resolved by adding parentheses. So, why not make a Code Fix that adds the parentheses? As it turns out, that is trivial.</p><p>Here&rsquo;s how it is done in Visual Studio:</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>namespace</span> <span class=nn>Microsoft</span><span class=p>.</span><span class=nn>VisualStudio</span><span class=p>.</span><span class=nn>FSharp</span><span class=p>.</span><span class=n>Editor</span>

<span class=k>open</span> <span class=nn>System.Composition</span>
<span class=k>open</span> <span class=nn>System.Threading</span>
<span class=k>open</span> <span class=nn>System.Threading.Tasks</span>

<span class=k>open</span> <span class=nn>Microsoft.CodeAnalysis.Text</span>
<span class=k>open</span> <span class=nn>Microsoft.CodeAnalysis.CodeFixes</span>
<span class=k>open</span> <span class=nn>Microsoft.CodeAnalysis.CodeActions</span>

<span class=o>[&lt;</span><span class=n>ExportCodeFixProvider</span><span class=o>(</span><span class=nn>FSharpConstants</span><span class=p>.</span><span class=n>FSharpLanguageName</span><span class=o>,</span> <span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;AddParentheses&#34;</span><span class=o>);</span> <span class=n>Shared</span><span class=o>&gt;]</span>
<span class=k>type</span> <span class=nc>internal</span> <span class=n>FSharpWrapExpressionInParenthesesFixProvider</span><span class=bp>()</span> <span class=o>=</span>
    <span class=k>inherit</span> <span class=n>CodeFixProvider</span><span class=bp>()</span>

    <span class=c1>// FS0597 is the ID for the diagnostic that gets triggered
</span><span class=c1></span>    <span class=k>let</span> <span class=nv>fixableDiagnosticIds</span> <span class=o>=</span> <span class=n>set</span> <span class=o>[</span><span class=s>&#34;FS0597&#34;</span><span class=o>]</span>

    <span class=k>override</span> <span class=n>_</span><span class=p>.</span><span class=nf>FixableDiagnosticIds</span> <span class=o>=</span> <span class=nn>Seq</span><span class=p>.</span><span class=n>toImmutableArray</span> <span class=n>fixableDiagnosticIds</span>

    <span class=k>override</span> <span class=n>this</span><span class=p>.</span><span class=nf>RegisterCodeFixesAsync</span> <span class=n>context</span> <span class=o>:</span> <span class=n>Task</span> <span class=o>=</span>
        <span class=n>async</span> <span class=o>{</span>
            <span class=c1>// Title comes from a resource file
</span><span class=c1></span>            <span class=k>let</span> <span class=nv>title</span> <span class=o>=</span> <span class=nn>SR</span><span class=p>.</span><span class=n>WrapExpressionInParentheses</span><span class=bp>()</span>

            <span class=k>let</span> <span class=nv>applicableIDs</span> <span class=o>=</span>
                <span class=n>context</span><span class=o>.</span><span class=n>Diagnostics</span>
                <span class=o>|&gt;</span> <span class=nn>Seq</span><span class=p>.</span><span class=n>filter</span> <span class=o>(</span><span class=k>fun</span> <span class=n>x</span> <span class=o>-&gt;</span> <span class=n>this</span><span class=o>.</span><span class=n>FixableDiagnosticIds</span><span class=o>.</span><span class=n>Contains</span> <span class=n>x</span><span class=o>.</span><span class=n>Id</span><span class=o>)</span>
                <span class=o>|&gt;</span> <span class=nn>Seq</span><span class=p>.</span><span class=n>toImmutableArray</span>

            <span class=c1>// This will wrap a range of text in parentheses
</span><span class=c1></span>            <span class=k>let</span> <span class=nv>getChangedText</span> <span class=o>(</span><span class=n>sourceText</span><span class=o>:</span> <span class=n>SourceText</span><span class=o>)</span> <span class=o>=</span>
                <span class=n>sourceText</span><span class=o>.</span><span class=n>WithChanges</span><span class=o>(</span><span class=n>TextChange</span><span class=o>(</span><span class=n>TextSpan</span><span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=n>Span</span><span class=o>.</span><span class=n>Start</span><span class=o>,</span> <span class=n>0</span><span class=o>),</span> <span class=s>&#34;(&#34;</span><span class=o>))</span>
                          <span class=o>.</span><span class=n>WithChanges</span><span class=o>(</span><span class=n>TextChange</span><span class=o>(</span><span class=n>TextSpan</span><span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=n>Span</span><span class=o>.</span><span class=n>End</span><span class=o>,</span> <span class=n>0</span><span class=o>),</span> <span class=s>&#34;)&#34;</span><span class=o>))</span>

            <span class=n>context</span><span class=o>.</span><span class=n>RegisterCodeFix</span><span class=o>(</span>
                <span class=nn>CodeAction</span><span class=p>.</span><span class=n>Create</span><span class=o>(</span>
                    <span class=n>title</span><span class=o>,</span>
                    <span class=o>(</span><span class=k>fun</span> <span class=o>(</span><span class=n>cancellationToken</span><span class=o>:</span> <span class=n>CancellationToken</span><span class=o>)</span> <span class=o>-&gt;</span>
                        <span class=n>async</span> <span class=o>{</span>
                            <span class=k>let!</span> <span class=nv>sourceText</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>Document</span><span class=o>.</span><span class=n>GetTextAsync</span><span class=o>(</span><span class=n>cancellationToken</span><span class=o>)</span> <span class=o>|&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>AwaitTask</span>
                            <span class=k>return</span> <span class=n>context</span><span class=o>.</span><span class=n>Document</span><span class=o>.</span><span class=n>WithText</span><span class=o>(</span><span class=n>getChangedText</span> <span class=n>sourceText</span><span class=o>)</span>
                        <span class=o>}</span> <span class=o>|&gt;</span> <span class=nn>RoslynHelpers</span><span class=p>.</span><span class=n>StartAsyncAsTask</span><span class=o>(</span><span class=n>cancellationToken</span><span class=o>)),</span>
                    <span class=n>title</span><span class=o>),</span>
                    <span class=n>applicableIDs</span><span class=o>)</span>
        <span class=o>}</span> <span class=o>|&gt;</span> <span class=nn>RoslynHelpers</span><span class=p>.</span><span class=n>StartAsyncUnitAsTask</span><span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=n>CancellationToken</span><span class=o>)</span>
</code></pre></div><p>Because the diagnostic itself has a range that encapsulates the entire troublesome expression, all we need to do is wrap parentheses around that range in a document.</p><p>The same quick fix in VSCode looks like this:</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=sd>/// a codefix that parenthesizes a member expression that needs it
</span><span class=sd></span><span class=k>let</span> <span class=nv>parenthesizeExpression</span> <span class=o>(</span><span class=n>getFileLines</span><span class=o>:</span> <span class=kt>string</span> <span class=o>-&gt;</span> <span class=n>Result</span><span class=o>&lt;</span><span class=kt>string</span> <span class=bp>[]</span><span class=o>,</span> <span class=o>_&gt;):</span> <span class=n>CodeFix</span> <span class=o>=</span>
  <span class=n>ifDiagnosticByCode</span>
    <span class=o>(</span><span class=k>fun</span> <span class=n>diagnostic</span> <span class=n>codeActionParams</span> <span class=o>-&gt;</span>
      <span class=k>match</span> <span class=n>getFileLines</span> <span class=o>(</span><span class=n>codeActionParams</span><span class=o>.</span><span class=n>TextDocument</span><span class=o>.</span><span class=n>GetFilePath</span><span class=bp>()</span><span class=o>)</span> <span class=k>with</span>
      <span class=o>|</span> <span class=n>Ok</span> <span class=n>lines</span> <span class=o>-&gt;</span>
          <span class=k>let</span> <span class=nv>erroringExpression</span> <span class=o>=</span> <span class=n>getText</span> <span class=n>lines</span> <span class=n>diagnostic</span><span class=o>.</span><span class=n>Range</span>
          <span class=n>async</span><span class=o>.</span><span class=n>Return</span> <span class=o>[</span> <span class=o>{</span> <span class=n>Title</span> <span class=o>=</span> <span class=s>&#34;Wrap expression in parentheses&#34;</span>
                           <span class=n>File</span> <span class=o>=</span> <span class=n>codeActionParams</span><span class=o>.</span><span class=n>TextDocument</span>
                           <span class=n>SourceDiagnostic</span> <span class=o>=</span> <span class=n>Some</span> <span class=n>diagnostic</span>
                           <span class=n>Edits</span> <span class=o>=</span>
                               <span class=o>[|</span> <span class=o>{</span> <span class=n>Range</span> <span class=o>=</span> <span class=n>diagnostic</span><span class=o>.</span><span class=n>Range</span>
                                    <span class=c1>// Using a string interpolation to supply new text
</span><span class=c1></span>                                    <span class=n>NewText</span> <span class=o>=</span> <span class=o>$</span><span class=s>&#34;(%s{erroringExpression})&#34;</span> <span class=o>}</span> <span class=o>|]</span>
                                    <span class=n>Kind</span> <span class=o>=</span> <span class=n>Fix</span> <span class=o>}</span> <span class=o>]</span>
      <span class=o>|</span> <span class=n>Error</span> <span class=o>_</span> <span class=o>-&gt;</span> <span class=n>async</span><span class=o>.</span><span class=n>Return</span> <span class=bp>[]</span><span class=o>)</span>
    <span class=o>(</span><span class=nn>Set</span><span class=p>.</span><span class=n>ofList</span> <span class=o>[</span> <span class=s>&#34;597&#34;</span> <span class=o>])</span>
</code></pre></div><p>This kind of easy quick fix can be written becase we have all the information we need right there. However, not every quick fix can be written so easily.</p><div class=gblog-post__anchorwrap><h2 id=harder-quick-fixer-example-scanning-the-text-in-a-document>Harder quick fixer example: scanning the text in a document
<a data-clipboard-text=https://phillipcarter.dev/posts/how-to-make-an-fsharp-code-fixer/#harder-quick-fixer-example-scanning-the-text-in-a-document class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Harder quick fixer example: scanning the text in a document" href=#harder-quick-fixer-example-scanning-the-text-in-a-document><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>Sometimes the error range for a diagnostic isn&rsquo;t enough information to inform a quick fix. But not all is lost! Sometimes all you have to do is scan through a document until you find something that gives you the information you need.</p><p>Consider the following error:</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=o>[&lt;</span><span class=n>EntryPoint</span><span class=o>&gt;]</span>
<span class=k>let</span> <span class=nv>main</span> <span class=n>argv</span> <span class=o>=</span>
    <span class=c1>// &#39;argv -1&#39; is an error
</span><span class=c1></span>    <span class=c1>// The range of the error, however, is only &#39;argv&#39;
</span><span class=c1></span>    <span class=k>for</span> <span class=n>x</span> <span class=o>=</span> <span class=n>0</span> <span class=k>to</span> <span class=n>argv</span> <span class=o>-</span><span class=n>1</span> <span class=k>do</span>
        <span class=n>printfn</span> <span class=s>&#34;uuuhhhhh&#34;</span>
</code></pre></div><p>The compiler will complain because it things you&rsquo;re calling argv as a function and passing <code>-1</code> to it. This can happen because <code>-</code> is both a binary and a unary operator, and the F# parser parses <code>-1</code> as a negation on 1, and the entire text of <code>-1</code> as a value being passed to argv. Since argv is not a function, this is obviously not correct.</p><p>Because the compiler error&rsquo;s range corresponds to argv, we don&rsquo;t actually have enough information to know that we can place a space between the <code>-</code> and the <code>1</code>. In fact, based on the error range being only for argv, we don&rsquo;t even know where in source the <code>-1</code> is! So we&rsquo;ll not only need to find its location, but also ensure that the next construct that comes after argv is indeed a <code>-</code>.</p><p>Luckily, this can be done as a recursive function or loop. Here&rsquo;s an example of scanning forward past the span corresponding to the diagnostic using Visual Studio APIs:</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>let</span> <span class=nv>pos</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>Span</span><span class=o>.</span><span class=n>End</span> <span class=o>+</span> <span class=n>1</span>

<span class=k>let</span> <span class=nv>nextNonWhitespaceText</span> <span class=o>=</span>
    <span class=k>let</span> <span class=nv>rec</span> <span class=n>loop</span> <span class=n>str</span> <span class=n>pos</span> <span class=o>=</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=o>(</span><span class=nn>String</span><span class=p>.</span><span class=n>IsNullOrWhiteSpace</span><span class=o>(</span><span class=n>str</span><span class=o>))</span> <span class=k>then</span>
            <span class=n>str</span>
        <span class=k>else</span>
            <span class=n>loop</span> <span class=o>(</span><span class=n>sourceText</span><span class=o>.</span><span class=n>GetSubText</span><span class=o>(</span><span class=n>TextSpan</span><span class=o>(</span><span class=n>pos</span> <span class=o>+</span> <span class=n>1</span><span class=o>,</span> <span class=n>1</span><span class=o>)))</span> <span class=o>(</span><span class=n>pos</span> <span class=o>+</span> <span class=n>1</span><span class=o>)</span>
    <span class=n>loop</span> <span class=o>(</span><span class=n>sourceText</span><span class=o>.</span><span class=n>GetSubText</span><span class=o>(</span><span class=n>TextSpan</span><span class=o>(</span><span class=n>pos</span><span class=o>,</span> <span class=n>1</span><span class=o>)))</span> <span class=n>pos</span>
</code></pre></div><p>This will grab a span of text that&rsquo;s exactly one character long, check it, and keep going until it&rsquo;s not whitespace. We can then check that nextNonWhitespaceText is equal to <code>-</code>. If it is, we can trigger a code fix! Here&rsquo;s how the entire code fixer can look:</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>namespace</span> <span class=nn>Microsoft</span><span class=p>.</span><span class=nn>VisualStudio</span><span class=p>.</span><span class=nn>FSharp</span><span class=p>.</span><span class=n>Editor</span>

<span class=k>open</span> <span class=nn>System</span>
<span class=k>open</span> <span class=nn>System.Composition</span>
<span class=k>open</span> <span class=nn>System.Threading.Tasks</span>

<span class=k>open</span> <span class=nn>Microsoft.CodeAnalysis.Text</span>
<span class=k>open</span> <span class=nn>Microsoft.CodeAnalysis.CodeFixes</span>

<span class=o>[&lt;</span><span class=n>ExportCodeFixProvider</span><span class=o>(</span><span class=nn>FSharpConstants</span><span class=p>.</span><span class=n>FSharpLanguageName</span><span class=o>,</span> <span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;ChangePrefixNegationToInfixSubtraction&#34;</span><span class=o>);</span> <span class=n>Shared</span><span class=o>&gt;]</span>
<span class=k>type</span> <span class=nc>internal</span> <span class=n>FSharpChangePrefixNegationToInfixSubtractionodeFixProvider</span><span class=bp>()</span> <span class=o>=</span>
    <span class=k>inherit</span> <span class=n>CodeFixProvider</span><span class=bp>()</span>

    <span class=k>let</span> <span class=nv>fixableDiagnosticIds</span> <span class=o>=</span> <span class=n>set</span> <span class=o>[</span><span class=s>&#34;FS0003&#34;</span><span class=o>]</span>

    <span class=k>override</span> <span class=n>_</span><span class=p>.</span><span class=nf>FixableDiagnosticIds</span> <span class=o>=</span> <span class=nn>Seq</span><span class=p>.</span><span class=n>toImmutableArray</span> <span class=n>fixableDiagnosticIds</span>

    <span class=k>override</span> <span class=n>_</span><span class=p>.</span><span class=nf>RegisterCodeFixesAsync</span> <span class=n>context</span> <span class=o>:</span> <span class=n>Task</span> <span class=o>=</span>
        <span class=n>asyncMaybe</span> <span class=o>{</span>
            <span class=k>let</span> <span class=nv>diagnostics</span> <span class=o>=</span>
                <span class=n>context</span><span class=o>.</span><span class=n>Diagnostics</span>
                <span class=o>|&gt;</span> <span class=nn>Seq</span><span class=p>.</span><span class=n>filter</span> <span class=o>(</span><span class=k>fun</span> <span class=n>x</span> <span class=o>-&gt;</span> <span class=n>fixableDiagnosticIds</span> <span class=o>|&gt;</span> <span class=nn>Set</span><span class=p>.</span><span class=n>contains</span> <span class=n>x</span><span class=o>.</span><span class=n>Id</span><span class=o>)</span>
                <span class=o>|&gt;</span> <span class=nn>Seq</span><span class=p>.</span><span class=n>toImmutableArray</span>

            <span class=k>let!</span> <span class=nv>sourceText</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>Document</span><span class=o>.</span><span class=n>GetTextAsync</span><span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=n>CancellationToken</span><span class=o>)</span>

            <span class=c1>// End of &#39;argv&#39;, in the case of the example above
</span><span class=c1></span>            <span class=k>let</span> <span class=nv>pos</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>Span</span><span class=o>.</span><span class=n>End</span> <span class=o>+</span> <span class=n>1</span>

            <span class=c1>// This won&#39;t ever actually happen, but it&#39;s good to check
</span><span class=c1></span>            <span class=k>do</span><span class=o>!</span> <span class=nn>Option</span><span class=p>.</span><span class=n>guard</span> <span class=o>(</span><span class=n>pos</span> <span class=o>&lt;</span> <span class=n>sourceText</span><span class=o>.</span><span class=n>Length</span><span class=o>)</span>

            <span class=k>let</span> <span class=nv>nextNonWhitespaceText</span> <span class=o>=</span>
                <span class=k>let</span> <span class=nv>rec</span> <span class=n>loop</span> <span class=n>str</span> <span class=n>pos</span> <span class=o>=</span>
                    <span class=k>if</span> <span class=ow>not</span> <span class=o>(</span><span class=nn>String</span><span class=p>.</span><span class=n>IsNullOrWhiteSpace</span><span class=o>(</span><span class=n>str</span><span class=o>))</span> <span class=k>then</span>
                        <span class=n>str</span>
                    <span class=k>else</span>
                        <span class=n>loop</span> <span class=o>(</span><span class=n>sourceText</span><span class=o>.</span><span class=n>GetSubText</span><span class=o>(</span><span class=n>TextSpan</span><span class=o>(</span><span class=n>pos</span> <span class=o>+</span> <span class=n>1</span><span class=o>,</span> <span class=n>1</span><span class=o>)))</span> <span class=o>(</span><span class=n>pos</span> <span class=o>+</span> <span class=n>1</span><span class=o>)</span>
                <span class=n>loop</span> <span class=o>(</span><span class=n>sourceText</span><span class=o>.</span><span class=n>GetSubText</span><span class=o>(</span><span class=n>TextSpan</span><span class=o>(</span><span class=n>pos</span><span class=o>,</span> <span class=n>1</span><span class=o>)))</span> <span class=n>pos</span>

            <span class=c1>// Bail if this isn&#39;t a negation
</span><span class=c1></span>            <span class=k>do</span><span class=o>!</span> <span class=nn>Option</span><span class=p>.</span><span class=n>guard</span> <span class=o>(</span><span class=n>nextNonWhitespaceText</span> <span class=o>=</span> <span class=s>&#34;-&#34;</span><span class=o>)</span>

            <span class=k>let</span> <span class=nv>title</span> <span class=o>=</span> <span class=nn>SR</span><span class=p>.</span><span class=n>ChangePrefixNegationToInfixSubtraction</span><span class=bp>()</span>

            <span class=k>let</span> <span class=nv>codeFix</span> <span class=o>=</span>
                <span class=nn>CodeFixHelpers</span><span class=p>.</span><span class=n>createTextChangeCodeFix</span><span class=o>(</span>
                    <span class=n>title</span><span class=o>,</span>
                    <span class=n>context</span><span class=o>,</span>
                    <span class=o>(</span><span class=k>fun</span> <span class=bp>()</span> <span class=o>-&gt;</span> <span class=n>asyncMaybe</span><span class=o>.</span><span class=n>Return</span> <span class=o>[|</span> <span class=n>TextChange</span><span class=o>(</span><span class=n>TextSpan</span><span class=o>(</span><span class=n>pos</span><span class=o>,</span> <span class=n>1</span><span class=o>),</span> <span class=s>&#34;- &#34;</span><span class=o>)</span> <span class=o>|]))</span>

            <span class=n>context</span><span class=o>.</span><span class=n>RegisterCodeFix</span><span class=o>(</span><span class=n>codeFix</span><span class=o>,</span> <span class=n>diagnostics</span><span class=o>)</span>
        <span class=o>}</span>
        <span class=o>|&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>Ignore</span>
        <span class=o>|&gt;</span> <span class=nn>RoslynHelpers</span><span class=p>.</span><span class=n>StartAsyncUnitAsTask</span><span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=n>CancellationToken</span><span class=o>)</span>
</code></pre></div><p>Note that the API calls are slightly different here. There is a helper defined called <code>createTextChangeCodeFix</code> that can be used, unlike in the previous example.</p><div class=gblog-post__anchorwrap><h2 id=harder-quick-fixe-example-checking-the-syntax-tree>Harder quick fixe example: checking the syntax tree
<a data-clipboard-text=https://phillipcarter.dev/posts/how-to-make-an-fsharp-code-fixer/#harder-quick-fixe-example-checking-the-syntax-tree class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Harder quick fixe example: checking the syntax tree" href=#harder-quick-fixe-example-checking-the-syntax-tree><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>Now things get a little more challenging. In the previous two examples, we could either work directly with a span of text in a document and change it, or scan the document to find what we need. But what if that&rsquo;s not enough? In some cases, you need to answer a more complicated question that corresponds to the actual struture of F# source code. Consider the following incorrect code:</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>let</span> <span class=nv>f</span> <span class=o>(</span><span class=n>x</span><span class=o>:</span> <span class=kt>bool</span><span class=o>)</span> <span class=o>(</span><span class=n>y</span><span class=o>:</span> <span class=kt>bool</span><span class=o>)</span> <span class=o>=</span>
    <span class=o>!</span><span class=n>x</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>y</span>
</code></pre></div><p>Someone without much F# (or OCaml) experience might thing that this is a boolean <code>not</code> operation. However, it is not! The <code>!</code> operator is used to dereference a <a class=gblog-post__link href=https://docs.microsoft.com/en-us/dotnet/fsharp/language-reference/reference-cells>Reference Cell</a>
. A correct fix would be to use the <code>not</code> operator:</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>let</span> <span class=nv>f</span> <span class=o>(</span><span class=n>x</span><span class=o>:</span> <span class=kt>bool</span><span class=o>)</span> <span class=o>(</span><span class=n>y</span><span class=o>:</span> <span class=kt>bool</span><span class=o>)</span> <span class=o>=</span>
    <span class=ow>not</span> <span class=n>x</span> <span class=o>&amp;&amp;</span> <span class=ow>not</span> <span class=n>y</span>
</code></pre></div><p>The diagnostic triggers on both <code>x</code> and <code>y</code> but it does not contain the text or position of !. Although it&rsquo;s possible to scan in a document to find the <code>!</code>, there&rsquo;s actually a much better approach: using the F# syntax tree APIs. Instead of relying on potentially error-prone custom scanning code, checking if a span of text is contained in a deference call (using <code>!</code>) will always be correct.</p><p>This can be trivially accomplished with a type extension on <code>FSharpParseFileResults</code>:</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>open</span> <span class=nn>FSharp.Compiler</span>
<span class=k>open</span> <span class=nn>FSharp.Compiler.Text</span>
<span class=k>open</span> <span class=nn>FSharp.Compiler.Range</span>
<span class=k>open</span> <span class=nn>FSharp.Compiler.SourceCodeServices</span>

<span class=o>[&lt;</span><span class=n>AutoOpen</span><span class=o>&gt;]</span>
<span class=k>module</span> <span class=nn>ParseTreeExtensions</span> <span class=o>=</span>
    <span class=k>type</span> <span class=nc>FSharpParseFileResults</span> <span class=k>with</span>
        <span class=k>member</span> <span class=n>scope</span><span class=p>.</span><span class=nf>TryRangeOfRefCellDereferenceContainingPos</span> <span class=n>expressionPos</span> <span class=o>=</span>
            <span class=k>match</span> <span class=n>scope</span><span class=o>.</span><span class=n>ParseTree</span> <span class=k>with</span>
            <span class=o>|</span> <span class=n>Some</span> <span class=n>input</span> <span class=o>-&gt;</span>
                <span class=nn>AstTraversal</span><span class=p>.</span><span class=n>Traverse</span><span class=o>(</span><span class=n>expressionPos</span><span class=o>,</span> <span class=n>input</span><span class=o>,</span> <span class=o>{</span> <span class=k>new</span> <span class=nn>AstTraversal</span><span class=p>.</span><span class=n>AstVisitorBase</span><span class=o>&lt;_&gt;</span><span class=bp>()</span> <span class=k>with</span>
                    <span class=k>member</span> <span class=n>_</span><span class=p>.</span><span class=nf>VisitExpr</span><span class=o>(_,</span> <span class=o>_,</span> <span class=n>defaultTraverse</span><span class=o>,</span> <span class=n>expr</span><span class=o>)</span> <span class=o>=</span>
                        <span class=k>match</span> <span class=n>expr</span> <span class=k>with</span>
                        <span class=o>|</span> <span class=nn>SynExpr</span><span class=p>.</span><span class=n>App</span><span class=o>(_,</span> <span class=k>false</span><span class=o>,</span> <span class=nn>SynExpr</span><span class=p>.</span><span class=n>Ident</span> <span class=n>funcIdent</span><span class=o>,</span> <span class=n>expr</span><span class=o>,</span> <span class=o>_)</span> <span class=o>-&gt;</span>
                            <span class=k>if</span> <span class=n>funcIdent</span><span class=o>.</span><span class=n>idText</span> <span class=o>=</span> <span class=s>&#34;op_Dereference&#34;</span> <span class=o>&amp;&amp;</span> <span class=n>rangeContainsPos</span> <span class=n>expr</span><span class=o>.</span><span class=n>Range</span> <span class=n>expressionPos</span> <span class=k>then</span>
                                <span class=n>Some</span> <span class=n>funcIdent</span><span class=o>.</span><span class=n>idRange</span>
                            <span class=k>else</span>
                                <span class=n>None</span>
                        <span class=o>|</span> <span class=o>_</span> <span class=o>-&gt;</span> <span class=n>defaultTraverse</span> <span class=n>expr</span> <span class=o>})</span>
            <span class=o>|</span> <span class=n>None</span> <span class=o>-&gt;</span> <span class=n>None</span>
</code></pre></div><p>The F# compiler services contain, among other things, a syntax tree visitor that has some default behavior you can override. You still need to implement <code>VisitExpr</code>, which is the exact one we&rsquo;re going to work with here.</p><p>If it looks complicated, don&rsquo;t worry! It&rsquo;s really not too bad. There is just a bit of terminology to understand:</p><ul><li>&ldquo;Range&rdquo; and &ldquo;Pos&rdquo;, such as in the <code>rangeContainsPos</code> call, refer to a range of text in a document (a line/column pair) and a position (a line and a column)</li><li><code>SynExpr.App</code> refers to a function application. All function applications contain a function expression and a argument expression of type <code>SynExpr</code></li><li><code>SynExpr.Ident</code> refers to an identifer in a syntax tree. It has a name (<code>idText</code>) and a range (<code>idRange</code>)</li></ul><p>In this case, the expression <code>!x</code> (or any of variant including arbitrary nesting of parentheses or whitespace) is just a <code>SynExpr.App</code> where the function expression is a <code>SynExpr.Ident</code> with <code>idText</code> of <code>op_Dereference</code>. So we just need to check that a given position is contained in the range of the argument that is being applied to <code>!</code>.</p><p>So, how do we call this? That&rsquo;s where a given editor API comes into play. In the case of Visual Studio, we need to convert from a Roslyn-based span of text to an F# compiler-based range of text (note the difference in terminology). Even though they both refer to the same thing, they have slightly different ways of representing the data.</p><p>We also need to parse a document to get access to an instance of <code>FSharpParseFileResults</code>. So if we refer back to the skeleton source code, the custom logic here is:</p><ol><li>Parse a document</li><li>Convert the code fix context&rsquo;s span of text into an F# range</li><li>Call our extension to <code>FSharpParseFileResults</code></li><li>Apply a code fix to the <code>!</code> if it exists</li></ol><p>Here&rsquo;s the full code snippet of the fixer:</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>namespace</span> <span class=nn>Microsoft</span><span class=p>.</span><span class=nn>VisualStudio</span><span class=p>.</span><span class=nn>FSharp</span><span class=p>.</span><span class=n>Editor</span>

<span class=k>open</span> <span class=nn>System.Composition</span>
<span class=k>open</span> <span class=nn>System.Threading.Tasks</span>

<span class=k>open</span> <span class=nn>Microsoft.CodeAnalysis.Text</span>
<span class=k>open</span> <span class=nn>Microsoft.CodeAnalysis.CodeFixes</span>

<span class=o>[&lt;</span><span class=n>ExportCodeFixProvider</span><span class=o>(</span><span class=nn>FSharpConstants</span><span class=p>.</span><span class=n>FSharpLanguageName</span><span class=o>,</span> <span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;ChangeRefCellDerefToNotExpression&#34;</span><span class=o>);</span> <span class=n>Shared</span><span class=o>&gt;]</span>
<span class=k>type</span> <span class=nc>internal</span> <span class=n>FSharpChangeRefCellDerefToNotExpressionCodeFixProvider</span>
    <span class=o>[&lt;</span><span class=n>ImportingConstructor</span><span class=o>&gt;]</span>
    <span class=o>(</span>
        <span class=n>checkerProvider</span><span class=o>:</span> <span class=n>FSharpCheckerProvider</span><span class=o>,</span>
        <span class=n>projectInfoManager</span><span class=o>:</span> <span class=n>FSharpProjectOptionsManager</span>
    <span class=o>)</span> <span class=o>=</span>
    <span class=k>inherit</span> <span class=n>CodeFixProvider</span><span class=bp>()</span>

    <span class=k>static</span> <span class=k>let</span> <span class=nv>userOpName</span> <span class=o>=</span> <span class=s>&#34;FSharpChangeRefCellDerefToNotExpressionCodeFix&#34;</span>
    <span class=k>let</span> <span class=nv>fixableDiagnosticIds</span> <span class=o>=</span> <span class=n>set</span> <span class=o>[</span><span class=s>&#34;FS0001&#34;</span><span class=o>]</span>

    <span class=k>override</span> <span class=n>__</span><span class=p>.</span><span class=nf>FixableDiagnosticIds</span> <span class=o>=</span> <span class=nn>Seq</span><span class=p>.</span><span class=n>toImmutableArray</span> <span class=n>fixableDiagnosticIds</span>

    <span class=k>override</span> <span class=n>this</span><span class=p>.</span><span class=nf>RegisterCodeFixesAsync</span> <span class=n>context</span> <span class=o>:</span> <span class=n>Task</span> <span class=o>=</span>
        <span class=n>asyncMaybe</span> <span class=o>{</span>
            <span class=c1>// All of this is setup to be able to parse a document
</span><span class=c1></span>            <span class=k>let</span> <span class=nv>document</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>Document</span>
            <span class=k>let!</span> <span class=nv>parsingOptions</span><span class=o>,</span> <span class=o>_</span> <span class=o>=</span> <span class=n>projectInfoManager</span><span class=o>.</span><span class=n>TryGetOptionsForEditingDocumentOrProject</span><span class=o>(</span><span class=n>document</span><span class=o>,</span> <span class=n>context</span><span class=o>.</span><span class=n>CancellationToken</span><span class=o>,</span> <span class=n>userOpName</span><span class=o>)</span>
            <span class=k>let!</span> <span class=nv>sourceText</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>Document</span><span class=o>.</span><span class=n>GetTextAsync</span><span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=n>CancellationToken</span><span class=o>)</span>

            <span class=c1>// The actual parsing call, which is slightly complex
</span><span class=c1></span>            <span class=k>let!</span> <span class=nv>parseResults</span> <span class=o>=</span> <span class=n>checkerProvider</span><span class=o>.</span><span class=n>Checker</span><span class=o>.</span><span class=n>ParseFile</span><span class=o>(</span><span class=n>document</span><span class=o>.</span><span class=n>FilePath</span><span class=o>,</span> <span class=n>sourceText</span><span class=o>.</span><span class=n>ToFSharpSourceText</span><span class=bp>()</span><span class=o>,</span> <span class=n>parsingOptions</span><span class=o>,</span> <span class=n>userOpName</span><span class=o>)</span> <span class=o>|&gt;</span> <span class=n>liftAsync</span>

            <span class=c1>// Converting to an F# range
</span><span class=c1></span>            <span class=k>let</span> <span class=nv>errorRange</span> <span class=o>=</span> <span class=nn>RoslynHelpers</span><span class=p>.</span><span class=n>TextSpanToFSharpRange</span><span class=o>(</span><span class=n>document</span><span class=o>.</span><span class=n>FilePath</span><span class=o>,</span> <span class=n>context</span><span class=o>.</span><span class=n>Span</span><span class=o>,</span> <span class=n>sourceText</span><span class=o>)</span>

            <span class=c1>// Getting a range of a dereference operator
</span><span class=c1></span>            <span class=k>let!</span> <span class=nv>derefRange</span> <span class=o>=</span> <span class=n>parseResults</span><span class=o>.</span><span class=n>TryRangeOfRefCellDereferenceContainingPos</span> <span class=n>errorRange</span><span class=o>.</span><span class=n>Start</span>

            <span class=c1>// Converting back into Roslyn-based spans
</span><span class=c1></span>            <span class=k>let!</span> <span class=nv>derefSpan</span> <span class=o>=</span> <span class=nn>RoslynHelpers</span><span class=p>.</span><span class=n>TryFSharpRangeToTextSpan</span><span class=o>(</span><span class=n>sourceText</span><span class=o>,</span> <span class=n>derefRange</span><span class=o>)</span>

            <span class=k>let</span> <span class=nv>title</span> <span class=o>=</span> <span class=nn>SR</span><span class=p>.</span><span class=n>UseNotForNegation</span><span class=bp>()</span>

            <span class=k>let</span> <span class=nv>diagnostics</span> <span class=o>=</span>
                <span class=n>context</span><span class=o>.</span><span class=n>Diagnostics</span>
                <span class=o>|&gt;</span> <span class=nn>Seq</span><span class=p>.</span><span class=n>filter</span> <span class=o>(</span><span class=k>fun</span> <span class=n>x</span> <span class=o>-&gt;</span> <span class=n>fixableDiagnosticIds</span> <span class=o>|&gt;</span> <span class=nn>Set</span><span class=p>.</span><span class=n>contains</span> <span class=n>x</span><span class=o>.</span><span class=n>Id</span><span class=o>)</span>
                <span class=o>|&gt;</span> <span class=nn>Seq</span><span class=p>.</span><span class=n>toImmutableArray</span>

            <span class=k>let</span> <span class=nv>codeFix</span> <span class=o>=</span>
                <span class=nn>CodeFixHelpers</span><span class=p>.</span><span class=n>createTextChangeCodeFix</span><span class=o>(</span>
                    <span class=n>title</span><span class=o>,</span>
                    <span class=n>context</span><span class=o>,</span>

                    <span class=c1>// The actual fix is trivial, just place `!` with `not `
</span><span class=c1></span>                    <span class=o>(</span><span class=k>fun</span> <span class=bp>()</span> <span class=o>-&gt;</span> <span class=n>asyncMaybe</span><span class=o>.</span><span class=n>Return</span> <span class=o>[|</span> <span class=n>TextChange</span><span class=o>(</span><span class=n>derefSpan</span><span class=o>,</span> <span class=s>&#34;not &#34;</span><span class=o>)</span> <span class=o>|]))</span>

            <span class=n>context</span><span class=o>.</span><span class=n>RegisterCodeFix</span><span class=o>(</span><span class=n>codeFix</span><span class=o>,</span> <span class=n>diagnostics</span><span class=o>)</span>
        <span class=o>}</span>
        <span class=o>|&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>Ignore</span>
        <span class=o>|&gt;</span> <span class=nn>RoslynHelpers</span><span class=p>.</span><span class=n>StartAsyncUnitAsTask</span><span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=n>CancellationToken</span><span class=o>)</span>
</code></pre></div><p>And that&rsquo;s it! There&rsquo;s a bit of ceremony to get access to the data we need and to convert back and forth between different textual representations, but after that the actual code fix is trivial.</p><p>Harder quick fixer example: analyzing semantics
Finally, you may also need to analyze F# semantics to be able to offer up a quick fix. Some errors that involve typechecking require you to analyze typecheck results to get the information that you&rsquo;re after.</p><p>Consider the following code:</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>let</span> <span class=nv>x</span> <span class=o>=</span> <span class=n>12</span>
<span class=n>x</span> <span class=o>&lt;-</span> <span class=n>13</span>
</code></pre></div><p>This will fail to compile because we&rsquo;re trying to mutate <code>x</code>, but it isn&rsquo;t declared as <code>mutable</code>. I personally run into this all the time because I won&rsquo;t always know that I want to mutate something until I decide it&rsquo;s necessary, then I have to go back and modify the declaration manually. Why not have a quick fixer do that?</p><p>To make this quick fixer, we need to now also analyze semantics, because we need to find the declaration location of a given value. Specifically, we&rsquo;ll need to do the following:</p><ol><li>Find the F# symbol for <code>x</code> in the erroneous <code>x &lt;- 13</code> call</li><li>Find the declaration of <code>x</code> once we&rsquo;ve resolved it at its use</li><li>Check that it&rsquo;s not a parameter (if it is, we can&rsquo;t declare it as <code>mutable</code>)</li><li>Apply the <code>mutable</code> keyword to the declaration of <code>x</code></li></ol><p>There&rsquo;s more code involved here than before, much of which is just boilerplate needed to be able to get a declaration of a value. Unfortunately, this boilerplate is fairly complex, so I would not classify this kind of code fix as easy.</p><p>This is what the boilerplate needed in Visual Studio to be able to get a declaration looks like, which I&rsquo;ve annotated to the best of my ability:</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=c1>// Just setting up some values and doing a quick check
</span><span class=c1></span><span class=k>let</span> <span class=nv>document</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>Document</span>
<span class=k>do</span><span class=o>!</span> <span class=nn>Option</span><span class=p>.</span><span class=n>guard</span> <span class=o>(</span><span class=ow>not</span><span class=o>(</span><span class=n>isSignatureFile</span> <span class=n>document</span><span class=o>.</span><span class=n>FilePath</span><span class=o>))</span>
<span class=k>let</span> <span class=nv>checker</span> <span class=o>=</span> <span class=n>checkerProvider</span><span class=o>.</span><span class=n>Checker</span>

<span class=c1>// This is critical. Use the START of the diagnostic span
</span><span class=c1></span><span class=k>let</span> <span class=nv>position</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>Span</span><span class=o>.</span><span class=n>Start</span>

<span class=c1>// Accessing the data that we need to make certain API calls
</span><span class=c1></span><span class=k>let!</span> <span class=nv>parsingOptions</span><span class=o>,</span> <span class=n>projectOptions</span> <span class=o>=</span> <span class=n>projectInfoManager</span><span class=o>.</span><span class=n>TryGetOptionsForEditingDocumentOrProject</span><span class=o>(</span><span class=n>document</span><span class=o>,</span> <span class=nn>CancellationToken</span><span class=p>.</span><span class=n>None</span><span class=o>,</span> <span class=n>userOpName</span><span class=o>)</span>
<span class=k>let!</span> <span class=nv>sourceText</span> <span class=o>=</span> <span class=n>document</span><span class=o>.</span><span class=n>GetTextAsync</span> <span class=bp>()</span> <span class=o>|&gt;</span> <span class=n>liftTaskAsync</span>
<span class=k>let</span> <span class=nv>defines</span> <span class=o>=</span> <span class=nn>CompilerEnvironment</span><span class=p>.</span><span class=n>GetCompilationDefinesForEditing</span> <span class=n>parsingOptions</span>
<span class=k>let</span> <span class=nv>textLine</span> <span class=o>=</span> <span class=n>sourceText</span><span class=o>.</span><span class=n>Lines</span><span class=o>.</span><span class=n>GetLineFromPosition</span> <span class=n>position</span>
<span class=k>let</span> <span class=nv>textLinePos</span> <span class=o>=</span> <span class=n>sourceText</span><span class=o>.</span><span class=n>Lines</span><span class=o>.</span><span class=n>GetLinePosition</span> <span class=n>position</span>
<span class=k>let</span> <span class=nv>fcsTextLineNumber</span> <span class=o>=</span> <span class=nn>Line</span><span class=p>.</span><span class=n>fromZ</span> <span class=n>textLinePos</span><span class=o>.</span><span class=n>Line</span>

<span class=c1>// Parse and typecheck a document, getting results for the parsing and typechecking
</span><span class=c1></span><span class=k>let!</span> <span class=nv>parseFileResults</span><span class=o>,</span> <span class=o>_,</span> <span class=n>checkFileResults</span> <span class=o>=</span> <span class=n>checker</span><span class=o>.</span><span class=n>ParseAndCheckDocument</span> <span class=o>(</span><span class=n>document</span><span class=o>,</span> <span class=n>projectOptions</span><span class=o>,</span> <span class=n>sourceText</span><span class=o>=</span><span class=n>sourceText</span><span class=o>,</span> <span class=n>userOpName</span><span class=o>=</span><span class=n>userOpName</span><span class=o>)</span>

<span class=c1>// Build a &#34;lexer symbol&#34; - this will quickly isolate the `x` from the rest of the expression and generate an F# SynExpr.Ident that can be used in other API calls
</span><span class=c1></span><span class=k>let!</span> <span class=nv>lexerSymbol</span> <span class=o>=</span> <span class=nn>Tokenizer</span><span class=p>.</span><span class=n>getSymbolAtPosition</span> <span class=o>(</span><span class=n>document</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span> <span class=n>sourceText</span><span class=o>,</span> <span class=n>position</span><span class=o>,</span> <span class=n>document</span><span class=o>.</span><span class=n>FilePath</span><span class=o>,</span> <span class=n>defines</span><span class=o>,</span> <span class=nn>SymbolLookupKind</span><span class=p>.</span><span class=n>Greedy</span><span class=o>,</span> <span class=k>false</span><span class=o>,</span> <span class=k>false</span><span class=o>)</span>

<span class=c1>// Finally, get the declaration of the symbol that a position corresponds to
</span><span class=c1></span><span class=k>let</span> <span class=nv>decl</span> <span class=o>=</span> <span class=n>checkFileResults</span><span class=o>.</span><span class=n>GetDeclarationLocation</span> <span class=o>(</span><span class=n>fcsTextLineNumber</span><span class=o>,</span> <span class=n>lexerSymbol</span><span class=o>.</span><span class=n>Ident</span><span class=o>.</span><span class=n>idRange</span><span class=o>.</span><span class=n>EndColumn</span><span class=o>,</span> <span class=n>textLine</span><span class=o>.</span><span class=n>ToString</span><span class=bp>()</span><span class=o>,</span> <span class=n>lexerSymbol</span><span class=o>.</span><span class=n>FullIsland</span><span class=o>,</span> <span class=k>false</span><span class=o>)</span>
<span class=n>It&#39;s</span> <span class=n>quite</span> <span class=n>a</span> <span class=n>lot</span><span class=o>,</span> <span class=ow>and</span> <span class=n>we&#39;re</span> <span class=n>planning</span> <span class=n>on</span> <span class=n>finding</span> <span class=n>ways</span> <span class=k>to</span> <span class=n>improve</span> <span class=n>F</span><span class=o>#</span> <span class=n>compiler</span> <span class=n>service</span> <span class=n>APIs</span> <span class=k>to</span> <span class=n>make</span> <span class=n>this</span> <span class=n>kind</span> <span class=k>of</span> <span class=n>boilerplate</span> <span class=n>no</span> <span class=n>longer</span> <span class=n>necessary</span><span class=o>.</span>
</code></pre></div><p>Next, we&rsquo;ll also need to detect if the declaration is contained within a parameter or not. We&rsquo;ll need to also have an <code>FSharpParseFileResults</code> extension like before:</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>open</span> <span class=nn>FSharp.Compiler</span>
<span class=k>open</span> <span class=nn>FSharp.Compiler.Text</span>
<span class=k>open</span> <span class=nn>FSharp.Compiler.Range</span>
<span class=k>open</span> <span class=nn>FSharp.Compiler.SourceCodeServices</span>

<span class=o>[&lt;</span><span class=n>AutoOpen</span><span class=o>&gt;]</span>
<span class=k>module</span> <span class=nn>ParseTreeExtensions</span> <span class=o>=</span>
    <span class=k>type</span> <span class=nc>FSharpParseFileResults</span> <span class=k>with</span>
        <span class=k>member</span> <span class=n>scope</span><span class=p>.</span><span class=nf>IsPositionContainedInACurriedParameter</span> <span class=n>pos</span> <span class=o>=</span>
            <span class=k>match</span> <span class=n>input</span> <span class=k>with</span>
            <span class=o>|</span> <span class=n>Some</span> <span class=n>input</span> <span class=o>-&gt;</span>
                <span class=k>let</span> <span class=nv>result</span> <span class=o>=</span>
                    <span class=nn>AstTraversal</span><span class=p>.</span><span class=n>Traverse</span><span class=o>(</span><span class=n>pos</span><span class=o>,</span> <span class=n>input</span><span class=o>,</span> <span class=o>{</span> <span class=k>new</span> <span class=nn>AstTraversal</span><span class=p>.</span><span class=n>AstVisitorBase</span><span class=o>&lt;_&gt;</span><span class=bp>()</span> <span class=k>with</span> 
                        <span class=k>member</span> <span class=n>_</span><span class=p>.</span><span class=nf>VisitExpr</span><span class=o>(_</span><span class=n>path</span><span class=o>,</span> <span class=n>traverseSynExpr</span><span class=o>,</span> <span class=n>defaultTraverse</span><span class=o>,</span> <span class=n>expr</span><span class=o>)</span> <span class=o>=</span>
                            <span class=n>defaultTraverse</span><span class=o>(</span><span class=n>expr</span><span class=o>)</span>

                        <span class=k>override</span> <span class=n>_</span><span class=p>.</span><span class=nf>VisitBinding</span> <span class=o>(_,</span> <span class=n>binding</span><span class=o>)</span> <span class=o>=</span>
                            <span class=k>match</span> <span class=n>binding</span> <span class=k>with</span>
                            <span class=o>|</span> <span class=n>Binding</span><span class=o>(_,</span> <span class=o>_,</span> <span class=o>_,</span> <span class=o>_,</span> <span class=o>_,</span> <span class=o>_,</span> <span class=n>valData</span><span class=o>,</span> <span class=o>_,</span> <span class=o>_,</span> <span class=o>_,</span> <span class=n>range</span><span class=o>,</span> <span class=o>_)</span> <span class=k>when</span> <span class=n>rangeContainsPos</span> <span class=n>range</span> <span class=n>pos</span> <span class=o>-&gt;</span>
                                <span class=k>let</span> <span class=nv>info</span> <span class=o>=</span> <span class=n>valData</span><span class=o>.</span><span class=n>SynValInfo</span><span class=o>.</span><span class=n>CurriedArgInfos</span>
                                <span class=k>let</span> <span class=nv>mutable</span> <span class=n>found</span> <span class=o>=</span> <span class=k>false</span>
                                <span class=k>for</span> <span class=n>group</span> <span class=k>in</span> <span class=n>info</span> <span class=k>do</span>
                                    <span class=k>for</span> <span class=n>arg</span> <span class=k>in</span> <span class=n>group</span> <span class=k>do</span>
                                        <span class=k>match</span> <span class=n>arg</span><span class=o>.</span><span class=n>Ident</span> <span class=k>with</span>
                                        <span class=o>|</span> <span class=n>Some</span> <span class=n>ident</span> <span class=k>when</span> <span class=n>rangeContainsPos</span> <span class=n>ident</span><span class=o>.</span><span class=n>idRange</span> <span class=n>pos</span> <span class=o>-&gt;</span>
                                            <span class=n>found</span> <span class=o>&lt;-</span> <span class=k>true</span>
                                        <span class=o>|</span> <span class=o>_</span> <span class=o>-&gt;</span> <span class=bp>()</span>
                                <span class=k>if</span> <span class=n>found</span> <span class=k>then</span> <span class=n>Some</span> <span class=n>range</span> <span class=k>else</span> <span class=n>None</span>
                            <span class=o>|</span> <span class=o>_</span> <span class=o>-&gt;</span>
                                <span class=n>None</span>
                    <span class=o>})</span>
                <span class=n>result</span><span class=o>.</span><span class=n>IsSome</span>
            <span class=o>|</span> <span class=o>_</span> <span class=o>-&gt;</span> <span class=k>false</span>
</code></pre></div><p>In this case, we just use <code>defaultTraverse</code> for any arbitary <code>SynExpr</code>, but we override the <code>VisitBinding</code> member. <code>VisitBinding</code> traverses a <code>SynExpr.Binding</code>, which is typicall a let binding. We need to then inspect data called <code>valData</code>, which contains a list of all curried parameter definitions for the binding, if they exist. We then loop through each and detect if the given position is within the range of one of the defined parameter bindings. For example, consider the following:</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>let</span> <span class=nv>f</span> <span class=o>(</span><span class=n>x</span><span class=o>:</span> <span class=n>int</span><span class=o>)</span> <span class=o>(</span><span class=n>y</span><span class=o>:</span> <span class=n>int</span><span class=o>)</span> <span class=o>=</span>
    <span class=n>x</span> <span class=o>&lt;-</span> <span class=n>12</span> <span class=c1>// Error
</span><span class=c1></span>    <span class=n>y</span>
</code></pre></div><p>This code will result in <code>x</code> being defined as a parameter. So we can pass the start position of its range to the tree traversal, which will then loop through each parameter until it finds the <code>x</code> definition. It will verify that the range of <code>x</code> contains the position we&rsquo;re after, return true, and then we&rsquo;ll know that <code>x</code> is defined as a parameter!</p><p>Putting it all together looks like this:</p><div class=highlight><pre class=chroma><code class=language-fsharp data-lang=fsharp><span class=k>namespace</span> <span class=nn>Microsoft</span><span class=p>.</span><span class=nn>VisualStudio</span><span class=p>.</span><span class=nn>FSharp</span><span class=p>.</span><span class=n>Editor</span>

<span class=k>open</span> <span class=nn>System.Composition</span>
<span class=k>open</span> <span class=nn>System.Threading</span>
<span class=k>open</span> <span class=nn>System.Threading.Tasks</span>

<span class=k>open</span> <span class=nn>Microsoft.CodeAnalysis.Text</span>
<span class=k>open</span> <span class=nn>Microsoft.CodeAnalysis.CodeFixes</span>

<span class=k>open</span> <span class=nn>FSharp.Compiler.Range</span>
<span class=k>open</span> <span class=nn>FSharp.Compiler.SourceCodeServices</span>
<span class=k>open</span> <span class=nn>FSharp.Compiler.AbstractIL.Internal.Library</span>

<span class=o>[&lt;</span><span class=n>ExportCodeFixProvider</span><span class=o>(</span><span class=nn>FSharpConstants</span><span class=p>.</span><span class=n>FSharpLanguageName</span><span class=o>,</span> <span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;MakeDeclarationMutable&#34;</span><span class=o>);</span> <span class=n>Shared</span><span class=o>&gt;]</span>
<span class=k>type</span> <span class=nc>internal</span> <span class=n>FSharpMakeDeclarationMutableFixProvider</span>
    <span class=o>[&lt;</span><span class=n>ImportingConstructor</span><span class=o>&gt;]</span>
    <span class=o>(</span>
        <span class=n>checkerProvider</span><span class=o>:</span> <span class=n>FSharpCheckerProvider</span><span class=o>,</span> 
        <span class=n>projectInfoManager</span><span class=o>:</span> <span class=n>FSharpProjectOptionsManager</span>
    <span class=o>)</span> <span class=o>=</span>
    <span class=k>inherit</span> <span class=n>CodeFixProvider</span><span class=bp>()</span>

    <span class=k>static</span> <span class=k>let</span> <span class=nv>userOpName</span> <span class=o>=</span> <span class=s>&#34;MakeDeclarationMutable&#34;</span>

    <span class=k>let</span> <span class=nv>fixableDiagnosticIds</span> <span class=o>=</span> <span class=n>set</span> <span class=o>[</span><span class=s>&#34;FS0027&#34;</span><span class=o>]</span>

    <span class=k>override</span> <span class=n>_</span><span class=p>.</span><span class=nf>FixableDiagnosticIds</span> <span class=o>=</span> <span class=nn>Seq</span><span class=p>.</span><span class=n>toImmutableArray</span> <span class=n>fixableDiagnosticIds</span>

    <span class=k>override</span> <span class=n>_</span><span class=p>.</span><span class=nf>RegisterCodeFixesAsync</span> <span class=n>context</span> <span class=o>:</span> <span class=n>Task</span> <span class=o>=</span>
        <span class=n>asyncMaybe</span> <span class=o>{</span>
            <span class=k>let</span> <span class=nv>diagnostics</span> <span class=o>=</span>
                <span class=n>context</span><span class=o>.</span><span class=n>Diagnostics</span>
                <span class=o>|&gt;</span> <span class=nn>Seq</span><span class=p>.</span><span class=n>filter</span> <span class=o>(</span><span class=k>fun</span> <span class=n>x</span> <span class=o>-&gt;</span> <span class=n>fixableDiagnosticIds</span> <span class=o>|&gt;</span> <span class=nn>Set</span><span class=p>.</span><span class=n>contains</span> <span class=n>x</span><span class=o>.</span><span class=n>Id</span><span class=o>)</span>
                <span class=o>|&gt;</span> <span class=nn>Seq</span><span class=p>.</span><span class=n>toImmutableArray</span>

            <span class=k>let</span> <span class=nv>document</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>Document</span>
            <span class=k>do</span><span class=o>!</span> <span class=nn>Option</span><span class=p>.</span><span class=n>guard</span> <span class=o>(</span><span class=ow>not</span><span class=o>(</span><span class=n>isSignatureFile</span> <span class=n>document</span><span class=o>.</span><span class=n>FilePath</span><span class=o>))</span>
            <span class=k>let</span> <span class=nv>position</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>Span</span><span class=o>.</span><span class=n>Start</span>
            <span class=k>let</span> <span class=nv>checker</span> <span class=o>=</span> <span class=n>checkerProvider</span><span class=o>.</span><span class=n>Checker</span>
            <span class=k>let!</span> <span class=nv>parsingOptions</span><span class=o>,</span> <span class=n>projectOptions</span> <span class=o>=</span> <span class=n>projectInfoManager</span><span class=o>.</span><span class=n>TryGetOptionsForEditingDocumentOrProject</span><span class=o>(</span><span class=n>document</span><span class=o>,</span> <span class=nn>CancellationToken</span><span class=p>.</span><span class=n>None</span><span class=o>,</span> <span class=n>userOpName</span><span class=o>)</span>
            <span class=k>let!</span> <span class=nv>sourceText</span> <span class=o>=</span> <span class=n>document</span><span class=o>.</span><span class=n>GetTextAsync</span> <span class=bp>()</span> <span class=o>|&gt;</span> <span class=n>liftTaskAsync</span>
            <span class=k>let</span> <span class=nv>defines</span> <span class=o>=</span> <span class=nn>CompilerEnvironment</span><span class=p>.</span><span class=n>GetCompilationDefinesForEditing</span> <span class=n>parsingOptions</span>
            <span class=k>let</span> <span class=nv>textLine</span> <span class=o>=</span> <span class=n>sourceText</span><span class=o>.</span><span class=n>Lines</span><span class=o>.</span><span class=n>GetLineFromPosition</span> <span class=n>position</span>
            <span class=k>let</span> <span class=nv>textLinePos</span> <span class=o>=</span> <span class=n>sourceText</span><span class=o>.</span><span class=n>Lines</span><span class=o>.</span><span class=n>GetLinePosition</span> <span class=n>position</span>
            <span class=k>let</span> <span class=nv>fcsTextLineNumber</span> <span class=o>=</span> <span class=nn>Line</span><span class=p>.</span><span class=n>fromZ</span> <span class=n>textLinePos</span><span class=o>.</span><span class=n>Line</span>
            <span class=k>let!</span> <span class=nv>parseFileResults</span><span class=o>,</span> <span class=o>_,</span> <span class=n>checkFileResults</span> <span class=o>=</span> <span class=n>checker</span><span class=o>.</span><span class=n>ParseAndCheckDocument</span> <span class=o>(</span><span class=n>document</span><span class=o>,</span> <span class=n>projectOptions</span><span class=o>,</span> <span class=n>sourceText</span><span class=o>=</span><span class=n>sourceText</span><span class=o>,</span> <span class=n>userOpName</span><span class=o>=</span><span class=n>userOpName</span><span class=o>)</span>
            <span class=k>let!</span> <span class=nv>lexerSymbol</span> <span class=o>=</span> <span class=nn>Tokenizer</span><span class=p>.</span><span class=n>getSymbolAtPosition</span> <span class=o>(</span><span class=n>document</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span> <span class=n>sourceText</span><span class=o>,</span> <span class=n>position</span><span class=o>,</span> <span class=n>document</span><span class=o>.</span><span class=n>FilePath</span><span class=o>,</span> <span class=n>defines</span><span class=o>,</span> <span class=nn>SymbolLookupKind</span><span class=p>.</span><span class=n>Greedy</span><span class=o>,</span> <span class=k>false</span><span class=o>,</span> <span class=k>false</span><span class=o>)</span>
            <span class=k>let</span> <span class=nv>decl</span> <span class=o>=</span> <span class=n>checkFileResults</span><span class=o>.</span><span class=n>GetDeclarationLocation</span> <span class=o>(</span><span class=n>fcsTextLineNumber</span><span class=o>,</span> <span class=n>lexerSymbol</span><span class=o>.</span><span class=n>Ident</span><span class=o>.</span><span class=n>idRange</span><span class=o>.</span><span class=n>EndColumn</span><span class=o>,</span> <span class=n>textLine</span><span class=o>.</span><span class=n>ToString</span><span class=bp>()</span><span class=o>,</span> <span class=n>lexerSymbol</span><span class=o>.</span><span class=n>FullIsland</span><span class=o>,</span> <span class=k>false</span><span class=o>)</span>

            <span class=k>match</span> <span class=n>decl</span> <span class=k>with</span>
            <span class=c1>// Only do this for symbols in the same file. That covers almost all cases anyways.
</span><span class=c1></span>            <span class=c1>// We really shouldn&#39;t encourage making values mutable outside of local scopes anyways.
</span><span class=c1></span>            <span class=o>|</span> <span class=nn>FSharpFindDeclResult</span><span class=p>.</span><span class=n>DeclFound</span> <span class=n>declRange</span> <span class=k>when</span> <span class=n>declRange</span><span class=o>.</span><span class=n>FileName</span> <span class=o>=</span> <span class=n>document</span><span class=o>.</span><span class=n>FilePath</span> <span class=o>-&gt;</span>
                <span class=k>let!</span> <span class=nv>span</span> <span class=o>=</span> <span class=nn>RoslynHelpers</span><span class=p>.</span><span class=n>TryFSharpRangeToTextSpan</span><span class=o>(</span><span class=n>sourceText</span><span class=o>,</span> <span class=n>declRange</span><span class=o>)</span>

                <span class=c1>// Bail if it&#39;s a parameter, because like, that ain&#39;t allowed
</span><span class=c1></span>                <span class=k>do</span><span class=o>!</span> <span class=nn>Option</span><span class=p>.</span><span class=n>guard</span> <span class=o>(</span><span class=ow>not</span> <span class=o>(</span><span class=n>parseFileResults</span><span class=o>.</span><span class=n>IsPositionContainedInACurriedParameter</span> <span class=n>declRange</span><span class=o>.</span><span class=n>Start</span><span class=o>))</span>

                <span class=k>let</span> <span class=nv>title</span> <span class=o>=</span> <span class=nn>SR</span><span class=p>.</span><span class=n>MakeDeclarationMutable</span><span class=bp>()</span>
                <span class=k>let</span> <span class=nv>codeFix</span> <span class=o>=</span>
                    <span class=nn>CodeFixHelpers</span><span class=p>.</span><span class=n>createTextChangeCodeFix</span><span class=o>(</span>
                        <span class=n>title</span><span class=o>,</span>
                        <span class=n>context</span><span class=o>,</span>
                        <span class=o>(</span><span class=k>fun</span> <span class=bp>()</span> <span class=o>-&gt;</span> <span class=n>asyncMaybe</span><span class=o>.</span><span class=n>Return</span> <span class=o>[|</span> <span class=n>TextChange</span><span class=o>(</span><span class=n>TextSpan</span><span class=o>(</span><span class=n>span</span><span class=o>.</span><span class=n>Start</span><span class=o>,</span> <span class=n>0</span><span class=o>),</span> <span class=s>&#34;mutable &#34;</span><span class=o>)</span> <span class=o>|]))</span>

                <span class=n>context</span><span class=o>.</span><span class=n>RegisterCodeFix</span><span class=o>(</span><span class=n>codeFix</span><span class=o>,</span> <span class=n>diagnostics</span><span class=o>)</span>
            <span class=o>|</span> <span class=o>_</span> <span class=o>-&gt;</span>
                <span class=bp>()</span>
        <span class=o>}</span>
        <span class=o>|&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>Ignore</span>
        <span class=o>|&gt;</span> <span class=nn>RoslynHelpers</span><span class=p>.</span><span class=n>StartAsyncUnitAsTask</span><span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=n>CancellationToken</span><span class=o>)</span>
</code></pre></div><p>And that&rsquo;s it!</p><div class=gblog-post__anchorwrap><h2 id=contribute-your-own-code-fixer>Contribute your own code fixer
<a data-clipboard-text=https://phillipcarter.dev/posts/how-to-make-an-fsharp-code-fixer/#contribute-your-own-code-fixer class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Contribute your own code fixer" href=#contribute-your-own-code-fixer><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>If you&rsquo;ve made it this far, you should be armed to add all kinds of code fixers. There is actually another class of fixer that I can discuss in another blog post, where we pair a code analyzer that raises custom diagnostics with a fixer that acts on those diagnostics. But the contents of this post should be enough to add lots of different kinds of fixers.</p><p>If you want to add one to Visual Studio, check out the fixers in the CodeFix folder. You can copy/paste one into a new file and change stuff as you go. Syntax tree extensions are typically moved into the F# compiler API itself, and with corresponding unit tests. But we can help you get that stuff added correctly during code review.</p><p>If you want to add one to VSCode, check out the CodeFixes file and take a look at the variety of code fixers available there and add a new one. I advise looking through the git history of the file to see where various helpers, such as syntax tree extensions, are located.</p><p>Happy code fixing!</p></section></article></main><footer class=gblog-footer><nav class=container><section class="flex flex-wrap align-center"><span class=gblog-footer__item><svg class="icon rss_feed"><use xlink:href="#rss_feed"/></svg><a href=/feed.xml class=gblog-footer__link>Atom Feed</a></span>
<span class=gblog-footer__item><svg class="icon twitter"><use xlink:href="#twitter"/></svg><a href=https://twitter.com/_cartermp class=gblog-footer__link>Twitter</a></span>
<span class=gblog-footer__item><svg class="icon github"><use xlink:href="#github"/></svg><a href=https://github.com/cartermp class=gblog-footer__link>GitHub</a></span></section><section class="flex flex-wrap align-center"><span class=gblog-footer__item>Built with <a href=https://gohugo.io/ class=gblog-footer__link>Hugo</a> and<svg class="icon heart"><use xlink:href="#heart"/></svg></span></section></nav></footer></div><script defer src=/js/clipboard-f06c52bfdd.min.js></script><script>document.addEventListener("DOMContentLoaded",function(a){var b=new ClipboardJS('.clip')})</script></body></html>